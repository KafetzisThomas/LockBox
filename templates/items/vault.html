{% extends "layout.html" %}

{% block title %}My Vault{% endblock title %}

{% block content %}
    <div class="mb-4">
        <div class="d-flex flex-column gap-2">
            <div class="d-flex w-100 w-md-50">
                <div class="input-group">
                    <span class="input-group-text bg-body-tertiary"><i class="bi bi-search"></i></span>
                    <input id="searchInput" class="form-control form-control-sm" type="search" placeholder="Search items..." onkeyup="filterItems()">
                </div>
            </div>
            <div class="d-flex w-100 w-md-50">
                <button class="btn btn-sm btn-primary w-100" type="button" data-bs-toggle="modal" data-bs-target="#createModal">
                    <i class="bi bi-plus-lg me-1"></i> New Item
                </button>
            </div>
        </div>
    </div>

    <div id="vaultList" class="d-flex flex-column gap-3"></div>

    <div id="emptyState" class="container text-center mt-3 d-none">
        <h5 class="text-muted">There are no items in the list.</h5>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
                <form id="createForm">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">New Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label for="newName" class="form-label">Name</label>
                        <input type="text" id="newName" class="form-control mb-3" required>

                        <label for="newContent" class="form-label">Secret / Password</label>
                        <input type="text" id="newContent" class="form-control" required>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
                <form id="editForm">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Edit Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editId">

                        <label for="editName" class="form-label">Name</label>
                        <input type="text" id="editName" class="form-control mb-3">

                        <label for="editContent" class="form-label">Secret</label>
                        <div class="input-group">
                            <input type="text" id="editContent" class="form-control">
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard()"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-danger" onclick="deleteItem()">Delete</button>
                        <button type="submit" class="btn btn-success">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const userId = sessionStorage.getItem('user_id');
        const vaultKeyJson = sessionStorage.getItem('vault_key');
        let vaultKey = null;

        const getModal = (id) => bootstrap.Modal.getOrCreateInstance(document.querySelector(id));

        if (!userId || !vaultKeyJson) {
            window.location.href = "/login";
        }

        (async function init() {
            try {
                // JSON string -> crypto key
                vaultKey = await importVaultKey(JSON.parse(vaultKeyJson));
                await loadItems();
            } catch (err) {
                console.error(err);
            }
        })();

        async function loadItems() {
            try {
                const res = await fetch(`/api/items?user_id=${userId}`);
                const items = await res.json();
                renderList(items);
            } catch (err) { 
                console.error(err); 
            }
        }

        async function renderList(items) {
            const listContainer = document.getElementById('vaultList');
            const emptyState = document.getElementById('emptyState');

            // reset empty state message if search filter changed it
            emptyState.querySelector('h5').textContent = "There are no items in the list.";
            listContainer.innerHTML = "";

            if (items.length === 0) {
                emptyState.classList.remove('d-none');
                return;
            }
            emptyState.classList.add('d-none');

            for (const item of items) {
                const domain = 'instagram.com';  // TODO: fetch url from api
                const dateStr = new Date(item.date_added).toLocaleDateString();
                const link = document.createElement('a');

                link.href = "#";
                link.className = "text-decoration-none item-card"; 
                link.setAttribute('data-name', item.name.toLowerCase());

                link.onclick = (e) => {
                    e.preventDefault();
                    if (window.getSelection().toString().length === 0) {
                        openEditModal(item);
                    }
                };

                link.innerHTML = `
                    <article class="media border-dark rounded shadow item-section p-3 d-flex align-items-center bg-white text-dark mb-0">
                        <div class="favicon-wrapper me-md-4 me-3">
                            <img src="https://www.google.com/s2/favicons?sz=64&domain=${domain}" alt="favicon" width="32" height="32">
                        </div>
                        <div class="media-body flex-grow-1">
                            <div class="item-metadata mb-0">
                                <small class="text-muted">${dateStr}</small>
                            </div>
                            <h2 class="mb-0 item-name h5 fw-bold">${item.name}</h2>
                        </div>
                        <i class="bi bi-chevron-right text-muted d-none d-md-block"></i>
                    </article>
                `;
                listContainer.appendChild(link);
            }
        }

        function filterItems() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.item-card');
            let hasVisible = false;

            cards.forEach(card => {
                const name = card.getAttribute('data-name');
                if (name.includes(query)) {
                    card.classList.remove('d-none');
                    hasVisible = true;
                } else {
                    card.classList.add('d-none');
                }
            });

            const emptyState = document.getElementById('emptyState');
            if (!hasVisible && cards.length > 0) {
                emptyState.classList.remove('d-none');
                emptyState.querySelector('h5').textContent = "No matches found.";
            } else if (cards.length === 0) {
                emptyState.classList.remove('d-none');
                emptyState.querySelector('h5').textContent = "There are no items in the list.";
            } else {
                emptyState.classList.add('d-none');
            }
        }

        document.getElementById('createForm').onsubmit = async (e) => {
            e.preventDefault();
            const encryptedHex = await encryptVaultItem(vaultKey, document.getElementById('newContent').value);
            await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: document.getElementById('newName').value,
                    encrypted_content: encryptedHex,
                    user_id: parseInt(userId)
                })
            });
            e.target.reset();
            getModal('#createModal').hide();
            loadItems();
        };

        async function openEditModal(item) {
            document.getElementById('editId').value = item.id;
            document.getElementById('editName').value = item.name;
            const secretInput = document.getElementById('editContent');
            getModal('#editModal').show();
            try {
                secretInput.value = await decryptVaultItem(vaultKey, item.encrypted_content);
            } catch (err) {
                secretInput.value = "Error";
            }
        }

        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const payload = { name: document.getElementById('editName').value };
            const content = document.getElementById('editContent').value;
            if(content) {
                payload.encrypted_content = await encryptVaultItem(vaultKey, content);
            }

            await fetch(`/api/items/${id}?user_id=${userId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            getModal('#editModal').hide();
            loadItems();
        };

        async function deleteItem() {
            if(confirm("Delete item?")) {
                const id = document.getElementById('editId').value;
                await fetch(`/api/items/${id}?user_id=${userId}`, { method: 'DELETE' });
                getModal('#editModal').hide();
                loadItems();
            }
        }

        function copyToClipboard() {
            const copyText = document.getElementById("editContent");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
        }
    </script>
{% endblock content %}
