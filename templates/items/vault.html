{% extends "layout.html" %}

{% block content %}
    <h2>My Vault</h2>
    <div style="margin-bottom: 20px;">
        <button onclick="document.getElementById('createModal').showModal()">Add New Item</button>
        <button onclick="logout()">Logout</button>
    </div>
    <hr>

    <h3>Saved Items</h3>
    <p id="loading">Loading vault...</p>
    <ul id="vaultList"></ul>

    <dialog id="createModal" style="padding: 20px; border: 1px solid #333;">
        <h3>Add New Item</h3>
        <form id="createForm" method="dialog">
            <label>Name:</label><br>
            <input type="text" id="newName" required><br><br>

            <label>Password / Secret:</label><br>
            <input type="text" id="newContent" required><br><br>

            <button type="submit" value="save">Save</button>
            <button type="button" onclick="document.getElementById('createModal').close()">Cancel</button>
        </form>
    </dialog>

    <dialog id="editModal" style="padding: 20px; border: 1px solid #333;">
        <h3>Edit Item</h3>
        <form id="editForm" method="dialog">
            <input type="hidden" id="editId">

            <label>Name:</label><br>
            <input type="text" id="editName"><br><br>

            <label>Password / Secret (leave blank to keep current):</label><br>
            <input type="text" id="editContent" placeholder="(Hidden)"><br><br>

            <button type="submit" value="save">Update</button>
            <button type="button" onclick="document.getElementById('editModal').close()">Cancel</button>
        </form>
    </dialog>

    <script>
        const userId = sessionStorage.getItem('user_id');
        const vaultKeyJson = sessionStorage.getItem('vault_key');
        let vaultKey = null;

        if (!userId || !vaultKeyJson) {
            window.location.href = "/login";
        }

        async function init() {
            try {
                // JSON string -> crypto key
                const jwk = JSON.parse(vaultKeyJson);
                vaultKey = await importVaultKey(jwk);
                await loadItems();
            } catch (err) {
                console.error(err);
                alert("Error loading encryption key. Please log in again.");
                window.location.href = "/login";
            }
        }

        async function loadItems() {
            const list = document.getElementById('vaultList');
            const loading = document.getElementById('loading');

            try {
                const res = await fetch(`/api/items?user_id=${userId}`);
                const items = await res.json();

                loading.style.display = 'none';
                list.innerHTML = "";

                if (items.length === 0) {
                    list.innerHTML = "<li>No items yet.</li>";
                    return;
                }

                for (const item of items) {
                    const plainPassword = await decryptVaultItem(vaultKey, item.encrypted_content);
                    const li = document.createElement('li');
                    li.style.marginBottom = "15px";
                    li.innerHTML = `
                        <strong>${item.name}</strong> 
                        <button onclick='openEditModal(${JSON.stringify(item)}, "${plainPassword}")'>Edit</button>
                        <button onclick="deleteItem(${item.id})">Delete</button>
                        <br>
                        <code>${plainPassword}</code>
                    `;
                    list.appendChild(li);
                }
            } catch (err) {
                loading.innerText = "Error: " + err;
            }
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();  // prevent default browser submission

            const name = document.getElementById('newName').value;
            const content = document.getElementById('newContent').value;
            const encryptedHex = await encryptVaultItem(vaultKey, content);

            await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    encrypted_content: encryptedHex,
                    user_id: parseInt(userId)
                })
            });
            document.getElementById('newName').value = "";
            document.getElementById('newContent').value = "";
            document.getElementById('createModal').close();
            loadItems(); 
        });

        // pass plain password so user can see what they are editing
        function openEditModal(item, plainPassword) {
            document.getElementById('editId').value = item.id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editContent').value = ""; 
            document.getElementById('editContent').placeholder = "Enter new password to change";
            document.getElementById('editModal').showModal();
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const content = document.getElementById('editContent').value;
            const payload = { name: name };

            if (content) {
                // only reencrypt if user typed a new password
                payload.encrypted_content = await encryptVaultItem(vaultKey, content);
            }

            await fetch(`/api/items/${id}?user_id=${userId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            document.getElementById('editModal').close();
            loadItems();
        });

        async function deleteItem(id) {
            if(!confirm("Delete this item?")) return;
            await fetch(`/api/items/${id}?user_id=${userId}`, { method: 'DELETE' });
            loadItems();
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = "/login";
        }

        init();
    </script>
{% endblock content %}
